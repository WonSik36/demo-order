# 영속성 관리
> 김영한 님의 _자바 ORM 표준 JPA 프로그래밍_ (에이콘출판주식회사, 2020) 을 읽고 정리하였습니다.

## 엔티티 매니저 팩토리와 엔티티 매니저
* 엔티티 매니저 팩토리
  * Thread-safe
  * 생성 비용이 큼
* 엔티티 매니저
  * Thread-unsafe
  * 생성 비용이 작음
  * 보통 트랜잭션을 시작할때 커넥션 획득

## 영속성 컨텍스트
* 엔티티를 영구 저장하는 환경
### 특징
* 영속 상태는 **식별자 값**이 반드시 있어야함
* **트랜잭션을 커밋**하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 데이터 베이스에 반영 (플러시)
### 장점
* 1차 캐시
  * 먼저 1차 캐시 조회후, 데이터베이스 조회
* 동일성 보장
* 트랜잭션을 지원하는 쓰기 지연
  * 쓰기 지연 SQL 저장소에서 Flush 할때, 쿼리 실행
* 변경 감지
  * 영속 상태의 엔티티에만 적용
* 지연 로딩
  * 실제 객체 대신 프록시 객체를 두고, 사용시 영속성 컨텍스트를 통해 데이터를 불러오는 방법

## 엔티티 생명주기
* 비영속(new/transient): 영속성 컨텍스트와 전혀 관계가 없는 상태
* 영속(managed): 영속성 컨텍스트에 저장된 상태
* 준영속(detached): 영속성 컨텍스트에 저장되었다가 분리된 상태
* 삭제(removed): 삭제된 상태

## 플러시
1. 변경 감지 동작, 수정된 엔티티에 대한 수정 쿼리를 만들어 쓰기 지연 SQL 저장소에 등록
2. 쓰기 지연 SQL 저장소의 쿼리 실행  
**주의**: 엔티티를 지우는것이 아님

### 플러시하는 방법
1. em.flush() 직접 호출
2. 트랜잭션 커밋 시 플러시가 자동으로 호출됨 (FlushModeType.AUTO, FlushModeType.COMMIT)
3. JPQL 쿼리 실행 시, 플러시가 자동으로 호출됨 (FlushModeType.AUTO)
